service: public-badges-api
variablesResolutionMode: 20210326

exclude:
  - node_modules
  - dist/assets
include:
  - node_modules/apollo-server-lambda/**/*
  - node_modules/graphql/**/*
  - node_modules/graphql-import-node/**/*
  - node_modules/graphql-playground-middleware-lambda/**/*
  - node_modules/graphql-scalars/**/*
  - node_modules/graphql-tools/**/*
  - node_modules/uuid/**/*
  - node_modules/voca/**/*
  - node_modules/ramda/**/*

custom:
  parameter_prefix: public-badges/${opt:stage}
  registry_bucket: ${ssm:/${self:custom.parameter_prefix}/registry/bucket}
  registry_lookup: ${ssm:/${self:custom.parameter_prefix}/registry/lookup_table}
  organization-status-index: ${ssm:/${self:custom.parameter_prefix}/registry/indices/organization_status}
  role: ${ssm:/${self:custom.parameter_prefix}/api/role}
  graphql: public-badges-${opt:stage}-graphql

provider:
  name: aws
  runtime: nodejs10.x
  region: eu-west-1
  lambdaHashingVersion: 20201221
  iam:
    role: ${self:custom.role}

functions:
  graphql:
    handler: ../dist/api/handler.graphql
    events:
      - http:
          path: graphql
          method: post
          cors: true
      - http:
          path: graphql
          method: get
          cors: true
      - http:
          path: playground
          method: any
          cors: true
    environment:
      REGISTRY_BUCKET: ${self:custom.registry_bucket}
      HANDLER_NAME: ${self:custom.graphql}
      REGISTRY_LOOKUP_TABLE: ${self:custom.registry_lookup}
      ORGANIZATION_STATUS_INDEX: ${self:custom.organization-status-index}
